<!DOCTYPE html>
<html>
<head>
    <title>aggreagated_throughput</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.run_count=0,this._init(),this._customComboBox()},_init:function(){this.legend="",this.nbr_back_track_month=3,this.nbr_back_track_days=0,this.todays_date=new Date,this.report_end_date=new Date(this.todays_date.getFullYear(),this.todays_date.getMonth(),0);var start_month_index=this.report_end_date.getMonth()-this.nbr_back_track_month+1,start_year=this.report_end_date.getFullYear();start_month_index<0&&(start_month_index+=12,start_year--),this.report_start_date=new Date(start_year,start_month_index,1),this.data_table=[],this.month_index={0:-1,1:-1,2:-1,3:-1,4:-1,5:-1,6:-1,7:-1,8:-1,9:-1,10:-1,11:-1},this.days_in_a_month=[31,28,31,30,31,30,31,31,30,31,30,31];for(var year=this.report_start_date.getFullYear(),start_month=this.report_start_date.getMonth(),i=0;i<this.nbr_back_track_month;i++)this.data_table[i]={month:new Date(year,start_month,1),display_date:start_month+1+"/"+year,velocity:0,count:0,Defects:0,Stories:0,Total:0},this.month_index[start_month]=i,start_month++,12===start_month&&(start_month=0,year++),this.nbr_back_track_days+=this.days_in_a_month[start_month];this.nbr_back_track_days+=this.todays_date.getDate(),this.end_month=start_month-1,console.log(" >>>>>>>>INTI>>>>>>>>>> "),console.log("range in months",this.nbr_back_track_month),console.log("range in days",this.nbr_back_track_days),console.log("start_date",this.report_start_date),console.log("end_date",this.report_end_date),console.log("data_table",this.data_table),console.log("month_index",this.month_index),console.log(" >>>>>>>>INTI>>>>>>>>>> "),this.run_count++,1===this.run_count&&this._loadPortfolioItems("MBI")},_portfolioChooserComboBox:function(){var app=this;app.portfolio_items_picker={xtype:"rallyportfolioitemtypecombobox",itemId:"portfolio_items_picker_id",alwaysExpanded:!1,autoExpand:!1,fieldLabel:"Select Portfolio Item",labelWidth:100,labelAlign:"right",listeners:{scope:app,select:app._main}},app.add(app.portfolio_items_picker)},_customComboBox:function(){var app=this,work_item=Ext.create("Ext.data.Store",{fields:["abbr","name"],data:[{abbr:"BI",name:"BI"},{abbr:"MBI",name:"MBI"},{abbr:"Feature",name:"Feature"},{abbr:"Story",name:"Stories & Defects"}]});app.portfolio_items_picker=Ext.create("Ext.form.ComboBox",{fieldLabel:"Choose Work Item",itemId:"portfolio_items_picker_id",store:work_item,queryMode:"local",displayField:"name",valueField:"abbr",multiSelect:!1,forceSelection:!0,listeners:{scope:app,select:app._main}}),app.add(app.portfolio_items_picker)},_main:function(){var app=this;app.setLoading("Processing - Please wait ..."),app._init();var selected_work_item=app.down("#portfolio_items_picker_id").rawValue;"Stories & Defects"===selected_work_item?app._loadStoriesAndDefects():app._loadPortfolioItems(selected_work_item),app.setLoading(!1)},_loadPortfolioItems:function(selected_portfolio_item){var app=this,filter1=Rally.data.wsapi.Filter.fromQueryString('(state = "Done")'),filter2=Rally.data.wsapi.Filter.fromQueryString("(StateChangedDate >= today-"+app.nbr_back_track_days+")"),filter=filter1.and(filter2);Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/"+selected_portfolio_item,autoLoad:!0,filters:filter,limit:1/0,sorters:[{property:"StateChangedDate",direction:"ASC"}],enableHierarchy:!0,listeners:{load:function(store,data){console.log(selected_portfolio_item," items: ",data),app._processPortfolioItems(data),app.data=data},scope:app},fetch:["c_PrimaryTeam","Project","LeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","AcceptedLeafStoryCount","FormattedID","Name","State","StateChangedDate"]})},_loadStoriesAndDefects:function(){var app=this,load_count=0,filter1=Rally.data.wsapi.Filter.fromQueryString('(ScheduleState = "Accepted")'),filter2=Rally.data.wsapi.Filter.fromQueryString("(AcceptedDate = Today-"+app.nbr_back_track_days+")"),filters=filter1.and(filter2);Ext.create("Rally.data.wsapi.Store",{model:"hierarchicalrequirement",filters:filters,sorters:[{property:"AcceptedDate",direction:"ASC"}],autoLoad:!0,limit:1/0,listeners:{load:function(store,data){load_count++,console.log("Loaded user stories ",load_count,data),app.stories=data,2===load_count&&app._processStoriesAndDefects(app.stories,app.defects)},scope:app},fetch:["FormattedID","AcceptedDate","Name","Project","ScheduleState","PlanEstimate","Tasks"]}),Ext.create("Rally.data.wsapi.Store",{model:"defect",filters:filters,sorters:[{property:"AcceptedDate",direction:"ASC"}],autoLoad:!0,limit:1/0,listeners:{load:function(store,data){load_count++,console.log("Loaded defects ",load_count,data),app.defects=data,2===load_count&&app._processStoriesAndDefects(app.stories,app.defects)},scope:app},fetch:["FormattedID","AcceptedDate","Name","Project","ScheduleState","PlanEstimate","Tasks"]})},_processStoriesAndDefects:function(stories,defects){console.log("processing stories & Defects");for(var app=this,total_count=0,total_velocity=0,skipped_count=0,accpeted_date,accepted_month,data_table_index,i=0;i<stories.length;i++)accpeted_date=stories[i].raw.AcceptedDate,accepted_month=new Date(accpeted_date).getMonth(),data_table_index=app.month_index[accepted_month],data_table_index!==-1?(total_count++,total_velocity+=stories[i].raw.PlanEstimate,app.data_table[data_table_index].velocity+=stories[i].raw.PlanEstimate,app.data_table[data_table_index].Stories++):skipped_count++;for(i=0;i<defects.length;i++)accpeted_date=defects[i].raw.AcceptedDate,accepted_month=new Date(accpeted_date).getMonth(),data_table_index=app.month_index[accepted_month],data_table_index!==-1?(total_count++,total_velocity+=defects[i].raw.PlanEstimate,app.data_table[data_table_index].velocity+=defects[i].raw.PlanEstimate,app.data_table[data_table_index].Defects++):skipped_count++;for(i=0;i<app.data_table.length;i++)app.data_table[i].Total=app.data_table[i].Defects+app.data_table[i].Stories;console.log("# of skipped stories ",skipped_count);var count_active_months=0;for(i=0;i<app.data_table.length;i++)app.data_table[i].velocity>0&&count_active_months++;console.log("data_table ",app.data_table),app._drawChartStoriesAndDefects(app.data_table),app.setLoading(!1)},_processPortfolioItems:function(portfolio_items){var app=this;console.log("processing portfolioitem");for(var total_count=0,total_velocity=0,skipped_count=0,i=0;i<portfolio_items.length;i++){var stateChangedDate=portfolio_items[i].raw.StateChangedDate,stateChangedDate_month=new Date(stateChangedDate).getMonth(),data_table_index=app.month_index[stateChangedDate_month];data_table_index!==-1?(total_count++,total_velocity+=portfolio_items[i].raw.AcceptedLeafStoryCount,app.data_table[data_table_index].velocity+=portfolio_items[i].raw.AcceptedLeafStoryCount,app.data_table[data_table_index].count++):skipped_count++}console.log("# of skipped portfolio_items ",skipped_count);var count_active_months=0;for(i=0;i<app.data_table.length;i++)app.data_table[i].velocity>0&&count_active_months++;console.log("data_table ",app.data_table);var table_legend="";app._drawChartPortfolioItems(app.data_table,table_legend)},_drawChartPortfolioItems:function(data_table,html_legend){var app=this;app.my_graph_chart&&app.my_graph_chart.destroy();var data_table_columns=["display_date","count"],store=Ext.create("Ext.data.JsonStore",{fields:data_table_columns,data:data_table}),my_series=[{type:"column",axis:"left",highlight:!0,stacked:!1,showInLegend:!0,tips:{trackMouse:!0,renderer:function(storeItem){this.setTitle(storeItem.get("count"))}},label:{display:"insideEnd",field:["count"],renderer:Ext.util.Format.numberRenderer("10"),orientation:"horizontal",color:"white","text-anchor":"middle"},xField:"display_date",yField:["count"]},{type:"line",axis:"left",highlight:!0,xField:"display_date",yField:"count",markerConfig:{type:"circle",size:3}}],my_axes=[{type:"Category",position:"bottom",fields:["display_date"],title:"Months",dateFormat:"M d",label:{rotate:{degrees:315}}},{type:"Numeric",position:"left",fields:["count"],stacked:!0,label:{renderer:Ext.util.Format.numberRenderer("0,0")},title:"Count of Work Items",grid:!0,minimum:0}];app.my_graph_chart=Ext.create("Ext.chart.Chart",{renderTo:Ext.getBody(),width:600,height:400,animate:!0,store:store,axes:my_axes,series:my_series,legend:{position:"bottom"}}),app._addLegend(html_legend),app.add(app.my_graph_chart)},_drawChartStoriesAndDefects:function(data_table,html_legend){var app=this;app.my_graph_chart&&app.my_graph_chart.destroy();var data_table_columns=["display_date","Stories","Defects","Total"],store=Ext.create("Ext.data.JsonStore",{fields:data_table_columns,data:data_table}),my_series=[{type:"column",axis:"left",highlight:!0,stacked:!0,showInLegend:!0,tips:{trackMouse:!0,renderer:function(storeItem){this.setTitle("Stories: "+storeItem.get("Stories")+"  Defects: "+storeItem.get("Defects"))}},label:{display:"insideEnd",field:["Stories","Defects","Total"],renderer:Ext.util.Format.numberRenderer("10"),orientation:"horizontal",color:"white","text-anchor":"middle"},xField:"display_date",yField:["Stories","Defects"]},{type:"line",axis:"left",highlight:!0,xField:"display_date",yField:"Total",markerConfig:{type:"circle",size:3}}],my_axes=[{type:"Category",position:"bottom",fields:["display_date"],title:"Months",dateFormat:"M d",label:{rotate:{degrees:315}}},{type:"Numeric",position:"left",fields:["Stories","Defects","Total"],stacked:!0,label:{renderer:Ext.util.Format.numberRenderer("0,0")},title:"Count of Work Items",grid:!0,minimum:0}];app.my_graph_chart=Ext.create("Ext.chart.Chart",{renderTo:Ext.getBody(),width:600,height:400,animate:!0,store:store,axes:my_axes,series:my_series,legend:{position:"bottom"}}),app._addLegend(html_legend),app.add(app.my_graph_chart)},_drawChartTemplate:function(){var app=this;app.my_graph_chart&&(console.log("Destroy my_graph_chart "),app.my_graph_chart.destroy());var data_table=[{iteration:"sprint one",team1:18,team2:12,sum:12,mean:30},{iteration:"sprint two",team1:24,team2:22,sum:22,mean:46},{iteration:"sprint three",team1:15,team2:12,sum:12,mean:27},{iteration:"sprint four",team1:12,team2:14,sum:12,mean:26},{iteration:"sprint five",team1:27,team2:38,sum:27,mean:65}],data_table_columns=["iteration","team1","team2","sum","mean"],store=Ext.create("Ext.data.JsonStore",{fields:data_table_columns,data:data_table}),my_series=[{type:"column",axis:"left",highlight:!0,label:{display:"insideEnd",field:["team1","team2"],renderer:Ext.util.Format.numberRenderer("10"),orientation:"horizontal",color:"black","text-anchor":"middle"},xField:"iteration",yField:["team1","team2"]},{type:"line",axis:"left",highlight:!0,xField:"iteration",yField:"sum",markerConfig:{type:"circle",size:3}},{type:"line",axis:"left",highlight:!0,xField:"iteration",yField:"mean",markerConfig:{type:"circle",size:3}}],my_axes=[{type:"Category",position:"bottom",fields:["iteration"],title:"Sample Metrics"},{type:"Numeric",position:"left",fields:["team1","team2","sum","mean"],stacked:!0,label:{renderer:Ext.util.Format.numberRenderer("0,0")},title:"Sample Values",grid:!0,minimum:0}];app.my_graph_chart=Ext.create("Ext.chart.Chart",{renderTo:Ext.getBody(),width:600,height:400,animate:!0,store:store,axes:my_axes,series:my_series,legend:{position:"top"}}),app.add(app.my_graph_chart)},_addLegend:function(html_legend){var app=this;app.legend=Ext.create("Ext.form.Panel",{title:html_legend}),app.add(app.legend)}});

            Rally.launchApp('CustomApp', {
                name:"aggreagated_throughput",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
