<!DOCTYPE html>
<html>
<head>
    <title>sprint_health</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function countDaysSince(given_date){var today=new Date,days_count=Math.round((given_date-today)/864e5);return console.log("days_count",days_count," from given_date",given_date),days_count}Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.object_count=0,this._loadIterations()},_loadIterations:function(){var app=this;app.iterComboBox={xtype:"rallyiterationcombobox",itemId:"iterComboBox-id",fieldLabel:"terations",labelAlign:"right",listeners:{ready:app._loadStoriesRecords,select:app._loadStoriesRecords,scope:app}},app.add(app.iterComboBox)},_loadStoriesRecords:function(){var app=this,selectedIterationRef=app.down("#iterComboBox-id").getRecord().get("_ref"),filter1=Rally.data.wsapi.Filter.fromQueryString('(Iteration = "'+selectedIterationRef+'")'),storyFilters=filter1;Ext.create("Rally.data.wsapi.Store",{model:"hierarchicalrequirement",filters:storyFilters,autoLoad:!0,limit:1/0,sorters:[{property:"Rank",direction:"ASC"}],listeners:{load:function(store,data){console.log("loaded story data ",data),app.object_count++,app.stories=data,app._start("User Stories")},scope:app},fetch:["FormattedID","Name","Project","ScheduleState","PlanEstimate","c_AcceptanceCriteria","Defects:Summary[State]","Tasks","TaskRemainingTotal","TaskActualTotal","TaskEstimateTotal","Blocked","InProgressDate","Iteration"]})},_start:function(from){var app=this;if(app.sprint_statistics_count={"% Done":0,"% WIP":0,Committed:0,"Not started":0,Active:0,Done:0,"Active older than 3 days":0,Blocked:0,Unestimated:0,"Without tasks":0,"Not accepted with todo = 0":0,"Accepted with todo > 0":0,"Can be accepted today":0},app.sprint_statistics_points={"% Done":0,"% WIP":0,Committed:0,"Not started":0,Active:0,Done:0,"Active older than 3 days":0,Blocked:0,Unestimated:"-","Without tasks":0,"Not accepted with todo = 0":0,"Accepted with todo > 0":0,"Can be accepted today":0},app.sprint_statistics_capacity={"% Done":0,"% WIP":0,Committed:0,"Not started":0,Active:0,Done:0,"Active older than 3 days":0,Blocked:0,Unestimated:0,"Without tasks":"-","Not accepted with todo = 0":0,"Accepted with todo > 0":0,"Can be accepted today":0},1!==app.object_count)return void console.log("Not ready to start, still loading data :",from);console.log("Data load completed at",from," processing has started ",app.stories,app.sprint_statistics);for(var i=0;i<app.stories.length;i++)app._processUserStories(app.stories[i].data);app.sprint_statistics_count["% Done"]=(100*(app.sprint_statistics_count.Done/app.sprint_statistics_count.Committed)).toFixed(2)+"%",app.sprint_statistics_points["% Done"]=(100*(app.sprint_statistics_points.Done/app.sprint_statistics_points.Committed)).toFixed(2)+"%",app.sprint_statistics_capacity["% Done"]=(100*(app.sprint_statistics_capacity.Done/app.sprint_statistics_capacity.Committed)).toFixed(2)+"%",app.sprint_statistics_count["% WIP"]=(100*(app.sprint_statistics_count.Active/app.sprint_statistics_count.Committed)).toFixed(2)+"%",app.sprint_statistics_points["% WIP"]=(100*(app.sprint_statistics_points.Active/app.sprint_statistics_points.Committed)).toFixed(2)+"%",app.sprint_statistics_capacity["% WIP"]=(100*(app.sprint_statistics_capacity.Active/app.sprint_statistics_capacity.Committed)).toFixed(2)+"%",app._displayGrid(),app.object_count=0},_processUserStories:function(story){var app=this;console.log(" porcesssing story #",story.FormattedID),app.sprint_statistics_points.Committed+=story.PlanEstimate,app.sprint_statistics_count.Committed++,app.sprint_statistics_capacity.Committed+=story.TaskEstimateTotal,"Defined"===story.ScheduleState&&(app.sprint_statistics_points["Not started"]+=story.PlanEstimate,app.sprint_statistics_count["Not started"]++,app.sprint_statistics_capacity["Not started"]+=story.TaskRemainingTotal),"Accepted"===story.ScheduleState&&(app.sprint_statistics_points.Done+=story.PlanEstimate,app.sprint_statistics_count.Done++,app.sprint_statistics_capacity.Done+=story.TaskActualTotal),story.Blocked&&(app.sprint_statistics_points.Blocked+=story.PlanEstimate,app.sprint_statistics_count.Blocked++,app.sprint_statistics_capacity.Blocked+=story.TaskRemainingTotal),0===story.Tasks.Count&&(app.sprint_statistics_points["Without tasks"]+=story.PlanEstimate,app.sprint_statistics_count["Without tasks"]++),"Accepted"===story.ScheduleState&&story.TaskRemainingTotal>0&&(app.sprint_statistics_points["Accepted with todo > 0"]+=story.PlanEstimate,app.sprint_statistics_count["Accepted with todo > 0"]++,app.sprint_statistics_capacity["Accepted with todo > 0"]+=story.TaskRemainingTotal),"Accepted"!==story.ScheduleState&&0===story.TaskRemainingTotal&&(app.sprint_statistics_points["Not accepted with todo = 0"]+=story.PlanEstimate,app.sprint_statistics_count["Not accepted with todo = 0"]++),"Accepted"!==story.ScheduleState&&story.TaskRemainingTotal<=6&&(app.sprint_statistics_points["Can be accepted today"]+=story.PlanEstimate,app.sprint_statistics_count["Can be accepted today"]++,app.sprint_statistics_capacity["Can be accepted today"]+=story.TaskRemainingTotal),null===story.PlanEstimate&&(app.sprint_statistics_count.Unestimated++,app.sprint_statistics_capacity.Unestimated+=story.TaskRemainingTotal),"In-Progress"!==story.ScheduleState&&"Completed"!==story.ScheduleState||(app.sprint_statistics_points.Active+=story.PlanEstimate,app.sprint_statistics_count.Active++,app.sprint_statistics_capacity.Active+=story.TaskRemainingTotal,countDaysSince(story.InProgressDate)<=-3&&(app.sprint_statistics_points["Active older than 3 days"]+=story.PlanEstimate,app.sprint_statistics_count["Active older than 3 days"]++,app.sprint_statistics_capacity["Active older than 3 days"]+=story.TaskRemainingTotal))},_displayGrid:function(){var app=this;app.sprint_stat_store={},app.myGrid&&app.myGrid.destroy();var legend="What's story does your sprint tell?",my_data=[];for(var key in app.sprint_statistics_count)app.sprint_statistics_count.hasOwnProperty(key)&&my_data.push({Metrics:key,Count:app.sprint_statistics_count[key],Points:app.sprint_statistics_points[key],Capacity:app.sprint_statistics_capacity[key]});console.log(" my_data ",my_data),app.sprint_stat_store=Ext.create("Ext.data.Store",{storeId:"Sprint_Health",fields:["Metrics","Count","Points","Capacity"],data:my_data,proxy:{type:"memory",reader:{type:"json",root:"items"}}}),app.myGrid=Ext.create("Ext.grid.Panel",{title:"Sprint Statistcs",store:app.sprint_stat_store,columns:[{text:"Metrics",dataIndex:"Metrics",width:"35%"},{text:"Count",dataIndex:"Count"},{text:"Points",dataIndex:"Points"},{text:"Capacity",dataIndex:"Capacity"}],height:800,width:"100%",maxHeight:"100%",tbar:[{xtype:"label",html:legend}],renderTo:Ext.getBody()}),app.add(app.myGrid)}});

            Rally.launchApp('CustomApp', {
                name:"sprint_health",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
