<!DOCTYPE html>
<html>
<head>
    <title>Aggregated-Throughput-II-MBI</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                function quarterOfTheYear(month){var quarter=Math.ceil((month+1)/3);return quarter}function monthRankInQuarter(month){return month%3+1}function monthLeftInQuarter(month){return month%3===0?2:month%3===1?1:month%3===2?0:void console.log("Something went wrong, this should never get executed")}function binarySerach(sortedObject,key,lookup_value){for(var start=0,end=sortedObject.length-1;start<=end;){var mid=Math.floor((start+end)/2),looking_at_value=sortedObject[mid].data[key];if(looking_at_value===lookup_value)return mid;lookup_value>looking_at_value?start=mid+1:end=mid-1}return-1}Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){this.flat_report=!0,this.legend={"No Entry":'<font color="Yellow">&#9679;&nbsp;</font>',Intake:'<font color="Black">&#9679;&nbsp;</font>',Discovering:'<font color="Orange">&#9679;&nbsp;</font>',Delivering:'<font color="Blue">&#9679;&nbsp;</font>',"Value Realization":'<font color="lightgreen">&#x2714;&nbsp;</font>',Done:'<font color="darkgreen">&#x2714;&nbsp;</font>',"Change in Delivery Date":"brown","On Time":"Black","Need Planned End Date":"DarkGray"},this.count={"No Entry":0,Intake:0,Discovering:0,Delivering:0,"Value Realization":0,Done:0,"Change in Delivery Date":0,"On Time":0,"Need Planned End Date":0},this.size_limit_1=75,this.size_limit_2=150,this.size_bucket_one_count="".concat("# of MBIs <= ",this.size_limit_1," points"),this.size_bucket_two_count="".concat("# of MBIs > ",this.size_limit_1," and <= ",this.size_limit_2," points"),this.size_bucket_three_count="".concat("# of MBIs > ",this.size_limit_2," points"),this.size_bucket_one="S ".concat(this.size_bucket_one),this.size_bucket_two="S ".concat(this.size_bucket_two),this.size_bucket_three="S ".concat(this.size_bucket_three),this.this_date=new Date,this._loadTagChooser(),this.scope=this.getContext().getProject().Name,console.log("main project: ",this.scope),this._setTimeline(),console.log("this_date ",this.this_date),console.log("report_start_date ",this.report_start_date),console.log("report_end_date ",this.report_end_date),this.months=["January","February","March","April","May","June","July","August","September","October","November","December"],this.quarter=["Q1","Q2","Q3","Q4"],this._buildReportHeader(),console.log("app.report_header",this.report_header),this.mbi_data_table=[],this.mbi_data_table_month_index={},this._buildGraphDataTable(),console.log("mbi_data_table",this.mbi_data_table),this.report=[],this.setLoading("Processing - Please wait ..."),this.object_count=0,this._loadProgram(),this._loadBI(),this._loadMBI(),this._loadMilestones(this.report_start_date,this.report_end_date)},_buildGraphDataTable:function(){for(var app=this,row={},i=1;i<app.report_header.length;i++)row.Month=app.report_header[i],row.Count=0,row.On_time=0,row.Changed_date=0,row.Need_planned_end_date=0,row.Velocity=0,row[app.size_bucket_one]=0,row[app.size_bucket_two]=0,row[app.size_bucket_three]=0,row[app.size_bucket_one_count]=0,row[app.size_bucket_two_count]=0,row[app.size_bucket_three_count]=0,app.mbi_data_table.push(row),row={},this.mbi_data_table_month_index[app.report_header[i]]=i-1},_loadTagChooser:function(){var app=this;app.tag_picker={xtype:"rallytagpicker",itemId:"tag-picker-id",alwaysExpanded:!1,autoExpand:!1,fieldLabel:"Tags",labelWidth:100,labelAlign:"right",storeConfig:{sorters:[{property:"Name",direction:"ASC"}],filters:[{property:"Archived",value:!1}]},listeners:{scope:app,selectionchange:app._getSelectedTagsValues}},app.add(app.tag_picker)},_getSelectedTagsValues:function(){var app=this,tag_objects=app.down("#tag-picker-id").getValue();app.user_tags=[];for(var i=0;i<tag_objects.length;i++)app.user_tags.push(tag_objects[i].data.Name);console.log("tags ",app.user_tags),console.log(" Reset few Global varibales for clean re-run"),app.mbi=[],app.report=[];for(var k in app.count)app.count.hasOwnProperty(k)&&(app.count[k]=0);app.object_count--,app._loadMBI()},_setTimeline:function(){var app=this;app.this_month=app.this_date.getMonth(),app.this_year=app.this_date.getFullYear(),app.this_day=app.this_date.getDay();var start_month=app.this_month-3,start_year=app.this_year;start_month<0&&(start_month+=12,start_year--),app.report_start_date=new Date(start_year,start_month,1);var end_month=app.this_month,end_year=app.this_year;app.report_end_date=new Date(end_year,end_month,0)},_buildReportHeader:function(){var app=this;console.log("_buildReportHeader");var year=app.report_start_date.getFullYear(),start_index=app.report_start_date.getMonth(),end_index=app.report_end_date.getMonth(),next_month;for(year<app.report_end_date.getFullYear()&&(end_index+=12),app.report_header=[],app.report_header.push("Program"),next_month=start_index;next_month<=end_index;next_month++)app.report_header.push(app._buildColumnName(next_month,year))},_buildColumnName:function(month_index,year){var app=this,date=new Date(year,month_index+1,0);return app._buildColumnNameFromDate(date)},_buildColumnNameFromDate:function(date){var app=this;if(date<app.report_start_date||date>app.report_end_date)return!1;var year=date.getFullYear(),index=date.getMonth(),adjusted_index=index;if(year>app.this_year&&(adjusted_index=index+12),app.flat_report)return app.months[index]+": "+year;var month_rank=monthRankInQuarter(app.this_month),month_left_in_quarter=monthLeftInQuarter(app.this_month),max_index_before_grouping=app.this_month+month_left_in_quarter;if(3===month_rank&&(max_index_before_grouping+=3),adjusted_index>max_index_before_grouping){var current_quarter_index=quarterOfTheYear(index)-1;return app.quarter[current_quarter_index]+": "+year}return app.months[index]+": "+year},_loadProgram:function(){var app=this;Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/Program",autoLoad:!0,limit:1/0,sorters:[{property:"Rank",direction:"ASC"}],enableHierarchy:!0,listeners:{load:function(store,data){app.object_count++,app.programs=data,app._start("Program")},scope:app},fetch:["FormattedID","Name","Milestones","State","PlannedEndDate","Children"]})},_loadBI:function(){var app=this;Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/BI",autoLoad:!0,limit:1/0,listeners:{load:function(store,data){app.object_count++,app.bi=data,app._start("BI")},scope:app}})},_loadMBI:function(){var app=this,mbi_filter1=Rally.data.wsapi.Filter.fromQueryString('(Project.Name  = "'+app.scope+'")'),mbi_filter2=Rally.data.wsapi.Filter.fromQueryString('(c_PrimaryTeam = "'+app.scope+'")'),myFilter=mbi_filter1.or(mbi_filter2);if("undefined"!=typeof app.user_tags&&app.user_tags.length>0){for(var mbi_filter3=Rally.data.wsapi.Filter.fromQueryString('(Tags.Name  = "'+app.user_tags[0]+'")'),i=1;i<app.user_tags.length;i++)mbi_filter3=mbi_filter3.or(Rally.data.wsapi.Filter.fromQueryString('(Tags.Name  = "'+app.user_tags[i]+'")'));myFilter=mbi_filter3.and(myFilter)}var mbi_filter4=Rally.data.wsapi.Filter.fromQueryString('(state = "Done")'),mbi_filter5=Rally.data.wsapi.Filter.fromQueryString('(state = "Value Realization")');myFilter=mbi_filter4.or(mbi_filter5).and(myFilter),Ext.create("Rally.data.wsapi.Store",{model:"portfolioitem/MBI",filters:myFilter,autoLoad:!0,limit:1/0,sorters:[{property:"Parent.FormattedID",direction:"DESC"}],listeners:{load:function(store,data){console.log("  MBI items count ",data.length),app.object_count++,app.mbi=data,app._start("MBI")},scope:app},fetch:["AcceptedLeafStoryPlanEstimateTotal","AcceptedLeafStoryCount","Project","Parent","FormattedID","Name","Milestones","State","PlannedEndDate","PlannedStartDate","ActualEndDate","ActualStartDate","Predecessors","Successors"]})},_loadMilestones:function(start_date,end_date){var app=this,cond1='(TargetDate >= "'.concat(start_date.getFullYear(),"-",start_date.getMonth()+1,"-",start_date.getDate(),'")'),cond2='(TargetDate <= "'.concat(end_date.getFullYear(),"-",end_date.getMonth()+1,"-",end_date.getDate(),'")'),ms_filter1=Rally.data.wsapi.Filter.fromQueryString(cond1),ms_filter2=Rally.data.wsapi.Filter.fromQueryString(cond2),ms_filters=ms_filter1.and(ms_filter2);Ext.create("Rally.data.wsapi.Store",{model:"Milestone",filters:ms_filters,autoLoad:!0,limit:1/0,sorters:[{property:"ObjectID",direction:"ASC"}],listeners:{load:function(store,data){app.object_count++,app.milestones=data,app._start("Milestones")},scope:app},fetch:["Projects","TargetDate","Summary","CreationDate","TargetProject","TotalArtifactCount","TotalProjectCount","Name","FormattedID","ObjectUUID"]})},_start:function(from){var app=this;if(4===app.object_count){console.log("Data load completed at",from," processing has started "),console.log("programs",app.programs),console.log("BI      ",app.bi),console.log("MBI      ",app.mbi),console.log("milestones",app.milestones);for(var i=0;i<app.mbi.length;i++){var mbi_report_columns=app._getMbiReportColumnKey(app.mbi[i]);mbi_report_columns!==-1&&app._addMBItoDataTable(app.mbi[i],mbi_report_columns)}for(i=0;i<app.mbi_data_table.length;i++)app.mbi_data_table[i].On_time=+(app.mbi_data_table[i].On_time/app.mbi_data_table[i].Count*100).toFixed(2);console.log("app.mbi_data_table",app.mbi_data_table),app._drawChart(app.mbi_data_table),app.setLoading(!1)}},_getMbiReportColumnKey:function(mbi){var app=this,i=0;if("undefined"==typeof mbi.raw.Milestones)return console.log("Skip MBI - no milestone is assigned ",mbi.raw.FormattedID),-1;var mbi_ms_objectIDs=[];for(i=0;i<mbi.raw.Milestones._tagsNameArray.length;i++){var start=mbi.raw.Milestones._tagsNameArray[i]._ref.lastIndexOf("/")+1;mbi_ms_objectIDs.push(parseInt(mbi.raw.Milestones._tagsNameArray[i]._ref.substring(start)))}var mbi_ms_indecies=[],ms_index;for(i=0;i<mbi_ms_objectIDs.length;i++)ms_index=binarySerach(app.milestones,"ObjectID",mbi_ms_objectIDs[i]),ms_index!==-1&&mbi_ms_indecies.push(ms_index);var mbi_ms_target_dates=[],index;for(i=0;i<mbi_ms_indecies.length;i++)index=mbi_ms_indecies[i],"undefined"!=typeof app.milestones[index].data.TargetDate&&mbi_ms_target_dates.push(app.milestones[index].data.TargetDate);var mbi_columns_new=[],row={},mbi_column;for(i=0;i<mbi_ms_target_dates.length;i++)if(row={},mbi_column=app._buildColumnNameFromDate(mbi_ms_target_dates[i])){row.column_key=mbi_column,row.state=-1,null!==mbi.data.PlannedEndDate&&""!==mbi.data.PlannedEndDate&&(mbi.data.PlannedEndDate<mbi_ms_target_dates[i]?row.state=1:mbi.data.PlannedEndDate>=mbi_ms_target_dates[i]&&(row.state=0));for(var y=-1,xx=0;xx<mbi_columns_new.length;xx++)"undefined"!=typeof mbi_columns_new[xx]&&mbi_columns_new[xx].column_key===mbi_column&&(y=xx,xx=mbi_columns_new.length);y===-1?mbi_columns_new.push(row):row.state<mbi_columns_new[y].state&&(mbi_columns_new[y].state=row.state)}return 0===mbi_columns_new.length?(console.log("Skip MBI - milestone(s) target date out of range OR mbi has no milestone: ",mbi.data.FormattedID),-1):mbi_columns_new},_addMBItoDataTable:function(mbi,columns){var app=this;columns.length>2&&console.log("Multi milestones",mbi.data.FormattedID),console.log("processing mbi for report",mbi.data.FormattedID),console.log("report / ms based columns",columns);for(var report_index=-1,i=0;i<columns.length;i++)report_index=app.mbi_data_table_month_index[columns[i].column_key],app.mbi_data_table[report_index].Count+=1,app.mbi_data_table[report_index].Velocity+=mbi.data.AcceptedLeafStoryPlanEstimateTotal,mbi.data.AcceptedLeafStoryPlanEstimateTotal<=app.size_limit_1?(app.mbi_data_table[report_index][app.size_bucket_one]+=mbi.data.AcceptedLeafStoryPlanEstimateTotal,app.mbi_data_table[report_index][app.size_bucket_one_count]+=1):mbi.data.AcceptedLeafStoryPlanEstimateTotal>app.size_limit_1&&mbi.data.AcceptedLeafStoryPlanEstimateTotal<=app.size_limit_2?(app.mbi_data_table[report_index][app.size_bucket_two]+=mbi.data.AcceptedLeafStoryPlanEstimateTotal,app.mbi_data_table[report_index][app.size_bucket_two_count]+=1):(app.mbi_data_table[report_index][app.size_bucket_three]+=mbi.data.AcceptedLeafStoryPlanEstimateTotal,app.mbi_data_table[report_index][app.size_bucket_three_count]+=1),1===columns[i].state?app.mbi_data_table[report_index].Changed_date+=1:0===columns[i].state?app.mbi_data_table[report_index].On_time+=1:app.mbi_data_table[report_index].Need_planned_end_date+=1},_drawChart:function(mbi_data_table){var app=this;app.my_graph_chart&&(console.log("Destroy my_graph_chart "),app.my_graph_chart.destroy());var data_table_columns=["Month","Count","On_time","Changed_time","Need_planned_end_date","Velocity",app.size_bucket_one,app.size_bucket_two,app.size_bucket_three,app.size_bucket_one_count,app.size_bucket_two_count,app.size_bucket_three_count],store=Ext.create("Ext.data.JsonStore",{fields:data_table_columns,data:mbi_data_table}),my_series=[{type:"column",axis:[app.size_bucket_one_count,app.size_bucket_two_count,app.size_bucket_three_count],highlight:!0,xField:"Month",yField:[app.size_bucket_one_count,app.size_bucket_two_count,app.size_bucket_three_count],stacked:!0,label:{display:"insideEnd",field:[app.size_bucket_one_count,app.size_bucket_two_count,app.size_bucket_three_count],renderer:Ext.util.Format.numberRenderer("10"),orientation:"horizontal",color:"black","text-anchor":"middle"}},{type:"line",axis:["On_time"],highlight:!0,xField:"Month",yField:["On_time"],stacked:!0,tips:{trackMouse:!0,renderer:function(storeItem){this.setTitle(storeItem.get("On_time"))}},label:{display:"insideEnd",field:["On_time"],renderer:Ext.util.Format.numberRenderer("10"),orientation:"horizontal",color:"black","text-anchor":"middle"}}],my_axes=[{type:"Category",position:"bottom",fields:["Month"],title:"Months"},{type:"Numeric",position:"left",fields:[app.size_bucket_one_count,app.size_bucket_two_count,app.size_bucket_three_count],stacked:!0,label:{renderer:Ext.util.Format.numberRenderer("0,0")},title:"# of MBIs",grid:!1,minimum:0},{type:"Numeric",position:"right",fields:["On_time"],title:"% on time"}];app.my_graph_chart=Ext.create("Ext.chart.Chart",{renderTo:Ext.getBody(),width:600,height:400,animate:!0,store:store,axes:my_axes,series:my_series,legend:{position:"right"}}),app.add(app.my_graph_chart)}});

            Rally.launchApp('CustomApp', {
                name:"Aggregated-Throughput-II-MBI",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
